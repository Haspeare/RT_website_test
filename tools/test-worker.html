<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Test Page</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #00ff00;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffff00; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #00ff00;
            color: #000;
            border: none;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
    </style>
</head>
<body>
    <h1>🧵 Web Worker Detection Test</h1>

    <div>
        <button onclick="testWorkerCreation()">1. Test Worker Creation</button>
        <button onclick="testONNXLoad()">2. Test ONNX Runtime Load</button>
        <button onclick="testModelPath()">3. Test Model Path</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <h2>Console Log:</h2>
    <div id="log" class="log"></div>

    <script>
        let worker = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testWorkerCreation() {
            log('=== Test 1: Worker Creation ===');
            try {
                if (worker) {
                    worker.terminate();
                    log('Previous worker terminated', 'warning');
                }

                worker = new Worker('./backends/detection-worker.js');
                log('✅ Worker created successfully!', 'success');

                worker.onmessage = (e) => {
                    log('📨 Message from worker: ' + JSON.stringify(e.data, null, 2), 'success');
                };

                worker.onerror = (error) => {
                    log('❌ Worker error: ' + error.message, 'error');
                    log('Error details: ' + JSON.stringify({
                        filename: error.filename,
                        lineno: error.lineno,
                        colno: error.colno
                    }), 'error');
                };

                log('Sending init message to worker...');
                worker.postMessage({ type: 'init' });

            } catch (error) {
                log('❌ Failed to create worker: ' + error.message, 'error');
            }
        }

        function testONNXLoad() {
            log('=== Test 2: ONNX Runtime Load ===');
            log('Testing ONNX Runtime from CDN...');

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js';
            script.onload = () => {
                log('✅ ONNX Runtime loaded in main thread', 'success');
                log('ort object available: ' + (typeof ort !== 'undefined'), 'success');
            };
            script.onerror = () => {
                log('❌ Failed to load ONNX Runtime from CDN', 'error');
            };
            document.head.appendChild(script);
        }

        async function testModelPath() {
            log('=== Test 3: Model Path ===');

            const paths = [
                '/mvt_rtdetr.onnx',
                './mvt_rtdetr.onnx',
                '../mvt_rtdetr.onnx',
                'mvt_rtdetr.onnx'
            ];

            for (const path of paths) {
                try {
                    log(`Testing path: ${path}`);
                    const response = await fetch(path, { method: 'HEAD' });
                    if (response.ok) {
                        log(`✅ Model found at: ${path}`, 'success');
                        log(`   Size: ${response.headers.get('content-length')} bytes`, 'success');
                        log(`   Type: ${response.headers.get('content-type')}`, 'success');
                    } else {
                        log(`❌ Model NOT found at: ${path} (${response.status})`, 'error');
                    }
                } catch (error) {
                    log(`❌ Error accessing: ${path} - ${error.message}`, 'error');
                }
            }
        }

        // Auto-run first test on load
        window.addEventListener('load', () => {
            log('Page loaded. Ready for testing.', 'success');
            log('Click buttons above to run tests.', 'warning');
        });
    </script>
</body>
</html>
